<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NYRAH Admin – Products</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/admin/dashboard.css">

  <style>
    body {
      background: #fae7eb;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .main {
      margin-left: 260px;
      padding: 35px;
     width: 90%;
     margin-top: 35px;
    }

.top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
  flex-wrap: nowrap;
  margin-bottom: 20px;
}
.top-bar h2 {
  margin: 0;
  white-space: nowrap;
}
    
.search-filter {
  display: flex;
  align-items: center;
  gap: 10px;
}

.search-box {
  display: flex;
  align-items: center;
  border: 2px solid #ddd;
  padding: 8px 14px;
  border-radius: 10px;
  background: #fff;
  width: 250px;
}

.search-box i {
  color: #777;
  margin-right: 8px;
  font-size: 18px;
}

.search-box input {
  border: none;
  outline: none;
  width: 180px;
}
.filter-dropdown {
  position: relative;
}
.filter-btn {
  background-color: #343a40;
  color: #fff;
  padding: 8px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}

.filter-content {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  background-color: #fff;
  min-width: 250px;
  padding: 15px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  border-radius: 5px;
  z-index: 1000;
}
.filter-dropdown.active .filter-content {
  display: block;
}
.filter-content select {
  width: 100%;
  padding: 6px 10px;
  margin-bottom: 10px;
  border-radius: 5px;
  border: 1px solid #ccc;
}
.filter-buttons {
  display: flex;
  justify-content: space-between;
}

.filter-buttons .btn-dark {
  background-color: #343a40;
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 5px;
}

.filter-buttons .btn-secondary {
  background-color: #6c757d;
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 5px;
}

    .btn-new {
      background: #ff2e78;
  color: #fff;
  padding: 8px 16px;
  border-radius: 6px;
  text-decoration: none;
  white-space: nowrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }

    thead {
      background: #f8f0f0;
    }

    .btn-edit {
      background: #2ba84a;
      padding: 6px 10px;
      color: #fff;
      border-radius: 5px;
      text-decoration: none;
    }

    .btn-delete {
      background: #e63946;
      padding: 6px 10px;
      color: #fff;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }

    .btn-offer {
      background: #000;
      padding: 6px 12px;
      color: #fff;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
    }

    .bg-success {
      background: green;
      color: #fff;
    }

    .bg-secondary {
      background: gray;
      color: #fff;
    }
  </style>
</head>
<body>
<div class="container">
<%- include('../../views/partials/admin/side')%>

  <main class="content">
   <header class="top-nav">
  <%- include('../../views/partials/admin/header')%>
</header>

<main class="main">


  <div class="top-bar">

    <h2>Products Management</h2>
    <div class="search-filter">
      <div class="search-box">
        <i class="bi bi-search"></i>
      <form method="GET" action="/admin/products">
  <input 
  type="text" 
  id="searchInput"
  name="search" 
  placeholder="Search by name"
  value="<%= search %>"
>
</form>
      </div>
       <a href="/admin/products" class="filter-btn"style="text-decoration:none">
  Clear
</a>
    </div> 
    <a href="/admin/products/add" class="btn-new">+ New</a>
  
 
<div class="filter-dropdown">
  <button class="filter-btn">Filter ▼</button>
  
  <div class="filter-content">
    <form method="GET" action="/admin/products">
      <select name="category">
        <option value="">All Categories</option>
        <% categories.forEach(cat => { %>
          <option value="<%= cat._id %>" <%= filters.category == cat._id ? "selected" : "" %>>
            <%= cat.name %>
          </option>
        <% }) %>
      </select>

      <select name="brand">
        <option value="">All Brands</option>
        <% brands.forEach(b => { %>
          <option value="<%= b._id %>" <%= filters.brand == b._id ? "selected" : "" %>>
            <%= b.brandName %>
          </option>
        <% }) %>
      </select>

      <select name="status">
        <option value="">All Status</option>
        <option value="active" <%= filters.status == "active" ? "selected" : "" %>>Active</option>
        <option value="blocked" <%= filters.status == "blocked" ? "selected" : "" %>>Blocked</option>
      </select>

      <div class="filter-buttons">
        <button class="btn btn-dark" type="submit">Apply</button>
        <a href="/admin/products" class="btn btn-secondary">Clear</a>
      </div>
    </form>
  </div>
</div>
  </div>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>ID</th>
        <th>Brand</th>
        <th>Category</th>
        <th>Price</th>
        <th>Qty</th>
        <th>Offer</th>
        <th>Variants</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody>
      <% products.forEach(p => { %>
        <tr>
          <td><%= p.productName %></td>
          <td><%= p._id %></td>
          <td><%= p.brand?.brandName || "-" %></td>
          <td><%= p.category?.name || "-" %></td>

          <td>
            <% if (p.productOffer > 0) { %>
              <span style="text-decoration: line-through; color:gray;">₹<%= p.regularPrice %></span><br>
              <strong>₹<%= p.salesPrice || (p.regularPrice - (p.regularPrice * p.productOffer / 100)) %></strong>
            <% } else { %>
              ₹<%= p.regularPrice %>
            <% } %>
          </td>

          <td><%= p.quantity %></td>

          <td>
            <% if (p.productOffer > 0) { %>
              <span class="badge bg-success"><%= p.productOffer %>% OFF</span>
            <% } else { %>
              <span class="badge bg-secondary">No Offer</span>
            <% } %>
          </td>
            <td>

  <a href="/admin/productVariants/<%= p._id %>"
     class="btn btn-sm btn-outline-secondary ms-2">
     Add Variant
  </a>
</td>

          <td>
            <a href="/admin/products/edit/<%= p._id %>" class="btn-edit">Edit</a>

            <form class="delete-product-form" data-id="<%= p._id %>" action="/admin/products/delete/<%= p._id %>" method="POST" style="display:inline;">
               <button type="submit" class="btn-delete">Delete</button>
               </form>

            <button type="button"
                    class="btn-offer"
                    data-id="<%= p._id %>"
                    data-hasoffer="<%= p.productOffer > 0 ? 1 : 0 %>">
              <%= p.productOffer > 0 ? "Remove Offer" : "Add Offer" %>
            </button>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>

</main>

<div id="offerModal" style="display:none; position:fixed; top:0; left:0;
            width:100%; height:100%; background:rgba(0,0,0,0.6);
            justify-content:center; align-items:center; z-index:2000;">
  <div style="background:#fff; padding:20px; border-radius:10px; text-align:center;">
    <h4>Add Offer (%)</h4>
    <input type="number" id="offerInput" min="1" max="99" style="width:120px; padding:6px; text-align:center;">
    <div style="margin-top:15px;">
      <button id="offerSaveBtn" class="btn-edit">Save</button>
      <button id="offerCancelBtn" class="btn-delete">Cancel</button>
    </div>
  </div>
</div>

<script>
  const offerModal = document.getElementById('offerModal');
  const offerInput = document.getElementById('offerInput');
  let currentProductId = null;

  document.querySelectorAll('.btn-offer').forEach(btn => {
    btn.addEventListener('click', () => {
      currentProductId = btn.dataset.id;
      const hasOffer = btn.dataset.hasoffer === '1';

      if (hasOffer) {
        fetch(`/admin/products/remove-offer/${currentProductId}`, { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            if (data.success) window.location.reload();
          });
      } else {
        offerModal.style.display = 'flex';
        offerInput.value = '';
      }
    });
  });
document.getElementById("searchInput").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
        e.preventDefault();
        let searchName = this.value.trim().toLowerCase();
        let rows = document.querySelectorAll("tbody tr");
        let found = false;
        rows.forEach(row => {
            let nameCell = row.querySelector("td"); 
            let productName = nameCell.innerText.trim().toLowerCase();
            if (productName === searchName) {
                row.style.display = "";
                found = true;
            } else {
                row.style.display = "none";
            }
        });
        if (!found && searchName !== "") {
            alert("product not found");
        }
    }
});
document.addEventListener("DOMContentLoaded", function() {
  const filterDropdown = document.querySelector(".filter-dropdown");
  const filterBtn = filterDropdown.querySelector(".filter-btn");

  filterBtn.addEventListener("click", () => {
    filterDropdown.classList.toggle("active");
  });
  window.addEventListener("click", function(e) {
    if (!filterDropdown.contains(e.target)) {
      filterDropdown.classList.remove("active");
    }
  });
});
  
  document.getElementById('offerSaveBtn').addEventListener('click', () => {
    const offer = offerInput.value;
    if (!offer || offer < 1 || offer > 99) return alert("Offer must be 1-99%");
    fetch(`/admin/products/add-offer/${currentProductId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ offer })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) window.location.reload();
      });
  });

  document.getElementById('offerCancelBtn').addEventListener('click', () => {
    offerModal.style.display = 'none';
  });
   const deleteForms = document.querySelectorAll('.delete-product-form');

  deleteForms.forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault(); // prevent immediate form submission

      Swal.fire({
        title: 'Are you sure?',
        text: "This product will be permanently deleted!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });
  });
</script>
</body>   
</html>