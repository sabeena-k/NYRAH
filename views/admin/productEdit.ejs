<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Product - NYRAH</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="/admin/dashboard.css">

<style>
body { background-color: #ffe6e6; }
.main { padding: 20px 40px; }
.form-box { background: #fff0f0; padding: 20px; border-radius: 10px; }
button.cancel { background: white; border: 1px solid #333; }
button.add { background: #f44c3a; color: white; }
.thumb-img { width: 80px; margin-right: 5px; border-radius: 5px; }
</style>
</head>

<body>
<div class="container-fluid d-flex">
  <%- include('../../views/partials/admin/side') %>

  <main class="main w-100">
    <h3 class="mb-3">Edit Product</h3>

    <div class="form-box">
      <form class="product-form"
            method="POST"
            action="/admin/products/edit/<%= product._id %>"
            enctype="multipart/form-data">

        <div class="mb-3">
          <label>Current Images</label><br>
          <% product.productImage.forEach(img => { %>
            <img src="/uploads/productImages/<%= img %>" class="thumb-img">
          <% }) %>
        </div>
        <div class="mb-3">
          <label>Add New Image (Crop Before Upload)</label>
          <input type="file" id="imageInput" accept="image/*">
        </div>
        <div class="mb-3">
          <img id="preview" style="max-width:150px; display:block;">
          <input type="hidden" name="croppedImage" id="croppedImage">
        </div>
        <div class="mb-3">
          <label>Product Name</label>
          <input type="text" name="name" class="form-control" value="<%= product.productName %>" required>
        </div>
        <div class="mb-3">
          <label>Description</label>
          <textarea name="description" class="form-control"><%= product.description %></textarea>
        </div>
        <div class="row">
          <div class="col">
            <label>Category</label>
            <select name="category" class="form-control">
     <option value="">Select Category</option>
      <% categories.forEach(cat => { %>
      <option value="<%= cat._id %>" 
      <%= product.category?._id.toString() === cat._id.toString() ? "selected" : "" %>>
      <%= cat.name %>
      </option>
      <% }) %>
      </select>

          </div>

          <div class="col">
            <label>Brand</label>
            <select name="brand" class="form-control">
              <% brands.forEach(b => { %>
                <option value="<%= b._id %>" <%= product.brand.toString() === b._id.toString() ? "selected" : "" %>>
                  <%= b.brandName %>
                </option>
              <% }) %>
            </select>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col">
            <label>Size</label>
            <% const sizeExtra = {
              "6 Month": 0, "6-12 Month": 50, "1-2 Years": 100, "2-3 Years": 150,
              "3-4 Years": 200, "4-5 Years": 250, "5-6 Years": 300, "6-7 Years": 350,
              "7-8 Years": 400, "8-9 Years": 450, "9-10 Years": 500
            }; %>

            <select name="size" id="sizeSelect" class="form-control">
              <% sizes.forEach(s => { %>
                <option value="<%= s %>"
                        data-extra="<%= sizeExtra[s] || 0 %>"
                        <%= product.size === s ? "selected" : "" %>>
                  <%= s %>
                </option>
              <% }) %>
            </select>
          </div>

          <div class="col">
            <label>Color</label>
            <select name="color" class="form-control">
              <% colors.forEach(c => { %>
                <option value="<%= c %>" <%= product.color === c ? "selected" : "" %>>
                  <%= c %>
                </option>
              <% }) %>
            </select>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col">
            <label>Price</label>
            <input type="number" name="price" id="priceInput" class="form-control"
                   value="<%= product.regularPrice %>" required>
          </div>
          <div class="col">
            <label>Offer Price</label>
            <input type="number" name="offerPrice" id="offerInput" class="form-control"
                   value="<%= product.salesPrice %>">
          </div>
        </div>

        <input type="hidden" id="basePrice" value="<%= product.regularPrice %>">

        <!-- QUANTITY -->
        <div class="mt-2">
          <label>Quantity</label>
          <input type="number" name="quantity" class="form-control"
                 value="<%= product.quantity %>">
        </div>

        <div class="mt-4">
          <button type="button" class="btn cancel" onclick="location.href='/admin/products'">Cancel</button>
          <button type="submit" class="btn add">Update Product</button>
        </div>

      </form>
    </div>
  </main>
</div>

<div id="cropModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:999; justify-content:center; align-items:center;">
  <div class="bg-white p-3 rounded">
    <img id="cropImage" style="max-width:400px">
    <button id="cropBtn" class="btn btn-primary mt-2">Crop</button>
    <button id="cancelCrop" class="btn btn-secondary mt-2">Cancel</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const sizeSelect = document.getElementById("sizeSelect");
const priceInput = document.getElementById("priceInput");
const offerInput = document.getElementById("offerInput");
const basePrice = Number(document.getElementById("basePrice").value);

function updatePrice() {
  const extra = Number(sizeSelect.selectedOptions[0].dataset.extra || 0);
  const finalPrice = basePrice + extra;
  priceInput.value = finalPrice;
  if(Number(offerInput.value) >= finalPrice) offerInput.value = finalPrice;
}
updatePrice();
sizeSelect.addEventListener("change", updatePrice);

document.querySelector(".product-form").addEventListener("submit", e => {
  if(Number(offerInput.value) >= Number(priceInput.value)) {
    e.preventDefault();
    Swal.fire("Error", "Offer price must be less than price", "error");
  }
});

// Cropper
let cropper;
const imageInput = document.getElementById("imageInput");
const cropModal = document.getElementById("cropModal");
const cropImage = document.getElementById("cropImage");
const cropBtn = document.getElementById("cropBtn");
const cancelCrop = document.getElementById("cancelCrop");
const preview = document.getElementById("preview");
const croppedInput = document.getElementById("croppedImage");

imageInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    cropImage.src = reader.result;
    cropModal.style.display = "flex";
    if(cropper) cropper.destroy();
    cropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 2, autoCropArea: 1 });
  };
  reader.readAsDataURL(file);
});

cropBtn.addEventListener("click", () => {
  if(!cropper) return;
  const canvas = cropper.getCroppedCanvas({ width: 500, height: 500 });
  const croppedData = canvas.toDataURL("image/jpeg");
  preview.src = croppedData;
  croppedInput.value = croppedData;
  cropModal.style.display = "none";
});

cancelCrop.addEventListener("click", () => {
  cropModal.style.display = "none";
  if(cropper) cropper.destroy();
});
</script>

</body>
</html>
