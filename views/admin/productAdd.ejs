<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NYRAH - Add New Product</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="/admin/dashboard.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
}

body {
    background-color: #fde2e2;
    color: #333;
    height: 100%;
}

.page-container {
    min-height: calc(100vh - 60px); 
    display: flex;
}
.content {
    margin-left: 250px;
    padding: 30px;
    width: 900px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Form */
.product-form {
    background: #ffeaea;
    padding: 25px;
    border-radius: 10px;
    margin-top: 20px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.row {
    display: flex;
    gap: 20px;
}

.input-box {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-top: 20px;
}

.input-box.full {
    width: 100%;
}

label {
    margin-bottom: 5px;
    font-weight: bold;
}

input, select, textarea {
    padding: 10px;
    border-radius: 7px;
    border: 1px solid #d19c9c;
    background: #fff;
}

textarea {
    min-height: 100px;
}

.image-upload-box {
    background: #ffe5e5;
    padding: 20px;
    border: 2px dashed #d19c9c;
    border-radius: 10px;
    text-align: center;
    margin-top: 10px;
}

.upload-btn {
    margin-top: 8px;
    padding: 8px 15px;
    border: none;
    background: #c7192b;
    color: white;
    border-radius: 5px;
}

.preview-row {
    display: flex;
    gap: 15px;
    margin-top: 15px;
    justify-content: center;
}

.preview-box {
    width: 120px;
    height: 100px;
    background: #e3c1c1;
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Buttons */
.btn-row {
    margin-top: 20px;
    text-align: right;
}

.cancel, .add {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    margin-left: 10px;
    cursor: pointer;
}

.cancel {
    background: #b6b6b6;
    color: white;
}

.add {
    background: #c7192b;
    color: white;
}
footer {
    text-align: center;
    padding: 20px 0;
    color: #444;
}
#cropBtn{
    background: rgb(185, 1, 1);
    color: white;
    width: 100px;
    height: 30px;
}

#closeModal{
  background: white;
  width: 100px;
  height: 30px;
  margin-top: 5px;
}
</style>

</head>

<body>

<div class="page-container">

    <%- include('../../views/partials/admin/side') %>

    <div class="content">
        <div class="header">
            <h2>Add New Product</h2>
        </div>

        <form class="product-form" method="POST" action="/admin/products/add" enctype="multipart/form-data">

    <div class="row">
        <div class="input-box">
            <label>Product Name</label>
            <input type="text" name="name" placeholder="Enter product name" required>
        </div>

        <div class="input-box">
            <label>Product ID</label>
            <input type="text" name="productId" placeholder="SKU-001" required>
        </div>
    </div>

    <div class="row">
        <div class="input-box">
            <label>Price â‚¹</label>
            <input type="number" name="price" placeholder="0.00" required>
        </div>

        <div class="input-box">
            <label>Offer Price</label>
            <input type="number" name="offerPrice" placeholder="0.00">
        </div>
    </div>

    <div class="input-box full">
        <label>Product Description</label>
        <textarea name="description" placeholder="Enter detailed product description..." required></textarea>
    </div>

    <div class="row">
        <div class="input-box">
            <label>Category</label>
            <select name="category" required>
                <% for(let i=0; i<cat.length; i++) { %>
                    <option value="<%= cat[i]._id %>"><%= cat[i].name %></option>
                <% } %>
            </select>
        </div>

        <div class="input-box">
            <label>Brand</label>
            <select name="brand" required>
                <% for(let i=0; i<brand.length; i++) { %>
                    <option value="<%= brand[i]._id %>"><%= brand[i].brandName %></option>
                <% } %>
            </select>
        </div>
    </div>

  <div class="row">
  <div class="input-box full">
    <label>Available Sizes</label>
   

    <select name="size" id="selectedSize" class="form-select" required>
      <% if(size && size.length > 0) { %>
        <% size.forEach(s => { %>
          <option value="<%= s %>"><%= s %></option>
        <% }) %>
      <% } else { %>
          <option value="">No sizes available</option>
      <% } %>
    </select>
  </div>



          <div class="input-box">
            <label>Quantity</label>
            <input type="text" name="quantity" required>
        </div>
    

        <div class="input-box">
            <label>Color</label>
            <input type="text" name="color" required>
        </div>
  </div>
<div class="image-upload-box">
  <p>Drag and drop images or click "Choose Images"</p>
  <button type="button" id="chooseBtn">Choose Images</button>
  <input type="file" name="images" id="imageInput" multiple accept="image/*" style="display:none">
  <div class="preview-row" id="preview"></div>
</div>

  <div id="cropModal" class="modal">
    <div class="modal-content">
      <img id="cropImage" style="max-width:100%">
      <button id="cropBtn" type="button">Crop & Save</button>
      <button id="closeModal" type="button">Cancel</button>
    </div>
  </div>

  <div class="btn-row">
    <button type="button" class="cancel">Cancel</button>
    <button type="submit" class="add">Add Product</button>
  </div>
</form>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
let cropper;
let croppedFiles = [];

const chooseBtn = document.getElementById("chooseBtn");
const fileInput = document.getElementById("imageInput");
const preview = document.getElementById("preview");

chooseBtn.addEventListener("click", () => fileInput.click());

fileInput.addEventListener("change", (e) => {
    if (e.target.files.length === 0) return;
    const file = e.target.files[0]; 
    const reader = new FileReader();
    reader.onload = () => {
        const cropModal = document.getElementById("cropModal");
        const cropImage = document.getElementById("cropImage");
        cropImage.src = reader.result;
        cropModal.style.display = "flex";

        if (cropper) cropper.destroy();
        cropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 2 });
    };
    reader.readAsDataURL(file);
});

document.getElementById("cropBtn").addEventListener("click", () => {
    const canvas = cropper.getCroppedCanvas({ width: 500, height: 500 });
    canvas.toBlob((blob) => {
        const file = new File([blob], Date.now() + ".jpg", { type: "image/jpeg" });
        croppedFiles.push(file);

        const dataTransfer = new DataTransfer();
        croppedFiles.forEach(f => dataTransfer.items.add(f));
        fileInput.files = dataTransfer.files;

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style.width = "100px";
        img.style.height = "100px";
        preview.appendChild(img);

        document.getElementById("cropModal").style.display = "none";
        cropper.destroy();
    }, "image/jpeg");
});
document.getElementById("closeModal").addEventListener("click", () => {
    document.getElementById("cropModal").style.display = "none";
    if (cropper) cropper.destroy();
});

document.querySelector(".cancel").addEventListener("click", () => {
    window.location.href = "/admin/products";
});
document.querySelector(".product-form").addEventListener("submit", function(e) {
    const regularPrice = Number(document.querySelector('input[name="price"]').value);
    const offerPrice = Number(document.querySelector('input[name="offerPrice"]').value);
    if (offerPrice >= regularPrice) {
        e.preventDefault(); 
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Offer price cannot be equal or greater than the regular price!'
        });
        return false;
    }
    if (croppedFiles.length === 0 && fileInput.files.length === 0) {
        e.preventDefault();
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please upload and crop at least one image!'
        });
        return false;
    }
});
</script>
</body>
</html>